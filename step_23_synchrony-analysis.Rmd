---
title: "Synchrony analysis DB-DOS"
author: "Joscelin Rocha-Hidalgo"
date: "`r Sys.Date()`"
output:
  html_document:
    df_print: paged
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Libraries
```{r packages, include=FALSE}
# Load the libraries
library(tidyverse)
library(readxl)
library(eeptools)
library(lme4)
library(afex)
library(cowplot)
source("packages/R_rainclouds.R")
library(PerformanceAnalytics)
library(modelsummary)
library(ggrepel)
library(report)
library(car)
library(ggeffects)
library(NatParksPalettes)
# devtools::install_github("johannesbjork/LaCroixColoR")
# remotes::install_github("m-clark/NineteenEightyR")
# remotes::install_github("jorvlan/raincloudplots")
library("NineteenEightyR")
library(PerformanceAnalytics)
library(ltm)
library(gt)
library(sjPlot)
library(mice)
library(ggrain)
library(emmeans)
library(interactions)
library(Hmisc)

filter <- dplyr::filter
mutate <- dplyr::mutate
select <- dplyr::select
summarise <- dplyr::summarise
summarize <- dplyr::summarize

theme_apa <- papaja::theme_apa

# Define a function to check for specific NA patterns
check_sequence <- function(x) {
  na_pattern_1 <- is.na(x[1]) && !is.na(x[2]) && is.na(x[3]) && !is.na(x[4])
  na_pattern_2 <- !is.na(x[1]) && is.na(x[2]) && !is.na(x[3]) && is.na(x[4])
  na_pattern_3 <- !is.na(x[1]) && is.na(x[2]) && is.na(x[3]) && !is.na(x[4])
  na_pattern_4 <- is.na(x[1]) && !is.na(x[2]) && is.na(x[3]) && !is.na(x[4])
  return(na_pattern_1 || na_pattern_2 || na_pattern_3 || na_pattern_4)
}
```


##  Import the datasets
```{r datasets}
# upload the datasets
#### Synchrony data
synch_data <- read_csv("data/wct_permuted_values_5_105.csv") %>%
  janitor::clean_names() %>%
  # select(-x1) %>%
  mutate(
    record_id = substr(as.character(parent), 1, 4),
    record_id = as.numeric(record_id)
  ) %>%
  relocate(record_id, .before = parent) %>%
  mutate(across(everything(), ~ ifelse(is.nan(.), NA, .)))


## CBQ

cbq_data_main_domains <- read_csv("questionnaires/output/2023-11-16/cbq_scores_big_three.csv") %>%
  janitor::clean_names()

cbq_data_main_subscales <- read_csv("questionnaires/output/2023-11-16/cbq_scores_subscales.csv") %>%
  janitor::clean_names()

## HBQ

hbq_data_overall <- read_csv("questionnaires/output/2023-11-16/hbq_scores_overall.csv") %>%
  janitor::clean_names() %>%
  rowwise() %>%
  mutate(anxiety_c = mean(c_across(c("hbq_internalizing_symptoms_overanxious", "hbq_internalizing_symptoms_separation_anxiety", "hbq_social_withdrawal_social_inhibition")), na.rm = TRUE)) %>%
  select(record_id, hbq_internalizing_symptoms_overanxious, hbq_internalizing_symptoms_separation_anxiety, hbq_social_withdrawal_social_inhibition, anxiety_c)


### STAI
stai_data <- read_csv("questionnaires/output/2023-11-16/stai_scores.csv") %>%
  janitor::clean_names()

### Demo (age)
load("data/primary_parent_sample_long.RData")
primary_parent_sample_long <- primary_parent_sample_long %>%
  select(record_id, site:p_latinx, income_house, p_edu, ladder_country, ladder_community)

## Merging them all
questionnaires_data <- cbq_data_main_domains %>%
  left_join(primary_parent_sample_long) %>%
  left_join(cbq_data_main_subscales) %>%
  left_join(stai_data) %>%
  left_join(hbq_data_overall) %>%
  select(record_id, stai_trait, stai_state, cbq_effortful_control, cbq_negative_affectivity, cbq_surgency, cbq_fear, anxiety_c)
```

## Finding the real dyads and Pseudo dyads

```{r}
### Creating variable to identify which ones are real dyads and which ones aren't
synchrony_data_per_trial <- synch_data %>%
  mutate(
    category = ifelse(
      substr(as.character(parent), 1, 4) == substr(as.character(child), 1, 4),
      1,
      0
    ),
    category = as.factor(category),
    baseline = 0
  ) %>%
  rowwise() %>%
  mutate(
    avg_score = mean(c_across(s1_d1_hbo:s8_d4_hbo), na.rm = TRUE),
    DLPFC_avg_score = mean(c_across(c("s3_d2_hbo", "s4_d2_hbo", "s5_d3_hbo", "s6_d3_hbo")), na.rm = TRUE),
    VLPFC_avg_score = mean(c_across(c("s1_d1_hbo", "s2_d1_hbo", "s2_d2_hbo", "s7_d3_hbo", "s7_d4_hbo", "s8_d4_hbo")), na.rm = TRUE),
  ) %>%
  ungroup()

synchrony_data <- synch_data %>%
  select(record_id:s8_d4_hbo) %>%
  pivot_longer(
    cols = starts_with("s"),
    names_to = "channel",
    values_to = "value"
  ) %>%
  group_by(record_id, parent, child, block, channel) %>%
  summarise(average = mean(value, na.rm = TRUE)) %>%
  pivot_wider(names_from = channel, values_from = average) %>%
  mutate(
    category = ifelse(
      substr(as.character(parent), 1, 4) == substr(as.character(child), 1, 4),
      1,
      0
    ),
    category = as.factor(category),
    baseline = 0
  ) %>%
  rowwise() %>%
  mutate(
    avg_score = mean(c_across(s1_d1_hbo:s8_d4_hbo), na.rm = TRUE),
    DLPFC_avg_score = mean(c_across(c("s3_d2_hbo", "s4_d2_hbo", "s5_d3_hbo", "s6_d3_hbo")), na.rm = TRUE),
    VLPFC_avg_score = mean(c_across(c("s1_d1_hbo", "s2_d1_hbo", "s2_d2_hbo", "s7_d3_hbo", "s7_d4_hbo", "s8_d4_hbo")), na.rm = TRUE),
  ) %>%
  ungroup()
```


## Adding Questionnaires
```{r}
synchrony_data$category <- recode_factor(synchrony_data$category, `1` = "Real Dyads", `0` = "Pseudo Dyads")
synchrony_data_per_trial$category <- recode_factor(synchrony_data_per_trial$category, `1` = "Real Dyads", `0` = "Pseudo Dyads")


nirs_records <- synchrony_data %>%
  select(record_id) %>%
  unique()


nirs_records_plus_demo <- nirs_records %>%
  left_join(primary_parent_sample_long)

nirs_records_plus_qst_df <- nirs_records %>%
  left_join(questionnaires_data)
```
## Impute data

```{r inpute-data, warning=FALSE}
# set number of imputations
n_imputations <- 25

# impute missing data
imp <- mice(nirs_records_plus_qst_df, m = n_imputations, seed = 3, print = FALSE)

# initialize empty list
imputed_data_list <- list()

# loop to store each imputed dataset
for (i in 1:n_imputations) {
  # store imputation iteration in list
  imputed_data_list[[i]] <- complete(imp, action = i)
}
```

### Combine imputed datasets

```{r}
# bind imputed data frames
combined_data <- do.call(rbind, imputed_data_list)
# collapse continuous variables, join with categorical variables

dat_long_imp <- combined_data %>%
  group_by(record_id) %>%
  summarise_all(mean, na.rm = TRUE) %>%
  ungroup()
```
## Joining dfs
```{r}
nirs_plus_qst <- synchrony_data %>%
  filter(category == "Real Dyads") %>%
  left_join(dat_long_imp) %>%
  left_join(primary_parent_sample_long)

nirs_per_trial_plus_qst <- synchrony_data_per_trial %>%
  filter(category == "Real Dyads") %>%
  left_join(dat_long_imp) %>%
  left_join(primary_parent_sample_long)


avg_1 <- nirs_plus_qst %>%
  distinct(record_id, .keep_all = TRUE) %>%
  select(c_age_y) %>%
  summarise(c_age_avg = mean(c_age_y, na.rm = TRUE)) %>%
  pull()

nirs_plus_qst <- nirs_plus_qst %>%
  mutate(c_age_y_centered = round(c_age_y - avg_1, 2))

nirs_per_trial_plus_qst <- nirs_per_trial_plus_qst %>%
  mutate(c_age_y_centered = round(c_age_y - avg_1, 2))

# remove dfs I won't need again
rm("imp", "dat_long_imp")
```

## Descriptives
### Num of dyads
```{r}
### Number of dyads per group (Pseudo = 0 vs Real = 1)
synchrony_data %>%
  mutate(unique_code = paste0(parent, child)) %>%
  distinct(unique_code, .keep_all = TRUE) %>%
  group_by(category) %>%
  count() %>%
  ungroup()
```

### Missing Channels
```{r}
### Number of missing channels per group (Pseudo = 0 vs Real = 1 => Category) & Block (1,2,3)
## Values => if 1 = Missing, 0 = not missing
synchrony_data %>%
  mutate(unique_code = paste0(parent, child)) %>%
  select(parent:category) %>%
  pivot_longer(cols = c(s1_d1_hbo:s8_d4_hbo), names_to = "channel", values_to = "values") %>%
  mutate(
    values = case_when(
      is.na(values) ~ "1",
      TRUE ~ "0"
    ),
    values = as.character(values)
  ) %>%
  group_by(category, block, values) %>%
  count() %>%
  ungroup()
```

### Mean Synchrony per Block

```{r}
### Mean synchrony per block for all Real Dyads
synchrony_data %>%
  filter(category == "Real Dyads") %>%
  group_by(block) %>%
  summarise(mean = round(mean(avg_score, .na.rm = TRUE), 2)) %>%
  ungroup()
```

### Age

```{r}
### Age
synchrony_data %>%
  filter(category == "Real Dyads") %>%
  select(record_id) %>%
  distinct(record_id) %>%
  left_join(primary_parent_sample_long) %>%
  summarise(
    child_age_mean = round(mean(c_age_y, na.rm = TRUE), 2),
    child_age_sd = round(sd(c_age_y, na.rm = TRUE), 2),
    child_age_min = round(min(c_age_y, na.rm = TRUE), 2),
    child_age_max = round(max(c_age_y, na.rm = TRUE), 2)
  )
```
### Location
```{r}
### Location
synchrony_data %>%
  filter(category == "Real Dyads") %>%
  select(record_id) %>%
  distinct(record_id) %>%
  left_join(primary_parent_sample_long) %>%
  group_by(site) %>%
  count() %>%
  ungroup()
```
### Sex Parent
```{r}
### Sex
synchrony_data %>%
  filter(category == "Real Dyads") %>%
  select(record_id) %>%
  distinct(record_id) %>%
  left_join(primary_parent_sample_long) %>%
  group_by(p_sex) %>%
  count() %>%
  ungroup()
```

### Sex Child
```{r}
### Sex Child
synchrony_data %>%
  filter(category == "Real Dyads") %>%
  select(record_id) %>%
  distinct(record_id) %>%
  left_join(primary_parent_sample_long) %>%
  group_by(c_sex) %>%
  count() %>%
  ungroup()
```

### Race Child
```{r}
## Race
synchrony_data %>%
  filter(category == "Real Dyads") %>%
  select(record_id) %>%
  distinct(record_id) %>%
  left_join(primary_parent_sample_long) %>%
  group_by(c_race) %>%
  count() %>%
  ungroup() %>%
  filter(c_race != "None") %>%
  mutate(percent = round(n / sum(n) * 100, 2))
```

### Race Parent
```{r}
## Race Parent

synchrony_data %>%
  filter(category == "Real Dyads") %>%
  select(record_id) %>%
  distinct(record_id) %>%
  left_join(primary_parent_sample_long) %>%
  group_by(p_race) %>%
  count() %>%
  ungroup() %>%
  filter(p_race != "None") %>%
  mutate(percent = round(n / sum(n) * 100, 2))
```

### Latinx Child
```{r}
## Latinx
synchrony_data %>%
  filter(category == "Real Dyads") %>%
  select(record_id) %>%
  distinct(record_id) %>%
  left_join(primary_parent_sample_long) %>%
  group_by(c_latinx) %>%
  count() %>%
  ungroup() %>%
  filter(c_latinx != "None") %>%
  mutate(percent = round(n / sum(n) * 100, 2))
```

### Latinx Parent
```{r}
## Latinx Parent

synchrony_data %>%
  filter(category == "Real Dyads") %>%
  select(record_id) %>%
  distinct(record_id) %>%
  left_join(primary_parent_sample_long) %>%
  group_by(p_latinx) %>%
  count() %>%
  ungroup() %>%
  filter(p_latinx != "None") %>%
  mutate(percent = round(n / sum(n) * 100, 2))
```
### Family income
```{r}
synchrony_data %>%
  filter(category == "Real Dyads") %>%
  select(record_id) %>%
  distinct(record_id) %>%
  left_join(primary_parent_sample_long) %>%
  group_by(income_house) %>%
  count() %>%
  ungroup() %>%
  filter(income_house != "None") %>%
  mutate(percent = round(n / sum(n) * 100, 2))
```

### Parent Education
```{r}
synchrony_data %>%
  filter(category == "Real Dyads") %>%
  select(record_id) %>%
  distinct(record_id) %>%
  left_join(primary_parent_sample_long) %>%
  group_by(p_edu) %>%
  count() %>%
  ungroup() %>%
  filter(p_edu != "None") %>%
  mutate(percent = round(n / sum(n) * 100, 2))
```
### Graph of real and Pseudo Dyads
#### PFC
```{r}
synchrony_data$category <- factor(synchrony_data$category, levels = c("Real Dyads", "Pseudo Dyads"))
# synchrony_data$trial <- factor(synchrony_data$trial, levels = c("Trial 1", "Trial 2","Trial 3","Trial 4"))

synchrony_data <- synchrony_data %>%
  mutate(new_block = case_when(
    block == "Block 1" ~ "Free Play Block",
    block == "Block 2" ~ "Stressful Block",
    block == "Block 3" ~ "Recovery Block",
    TRUE ~ "Error"
  ))

synchrony_data$new_block <- factor(synchrony_data$new_block, levels = c("Free Play Block", "Stressful Block", "Recovery Block"))

synchrony_data %>%
  ggplot(., aes(x = category, y = avg_score, fill = category, col = category)) +
  geom_flat_violin(position = position_nudge(x = .2, y = 0), alpha = .2, adjust = 4) +
  geom_point(position = position_jitter(width = .10), size = 1, alpha = 0.4) +
  scale_fill_brewer(palette = "Dark2") +
  scale_colour_brewer(palette = "Dark2") +
  guides(fill = FALSE, col = FALSE) +
  geom_boxplot(aes(x = as.numeric(category) + 0.25, y = avg_score), outlier.shape = NA, alpha = 0.4, width = .1, colour = "BLACK") +
  ylab("Synchrony Values (PFC)") +
  xlab("Dyads Type") +
  stat_summary(fun.data = "mean_cl_normal", geom = "errorbar", width = 1 / 4, color = "black") +
  stat_summary(fun = "mean", geom = "point", color = "black") +
  theme_apa() +
  facet_wrap(~new_block, nrow = 1) +
  theme(text = element_text(size = 30)) +
  scale_x_discrete(labels = function(x) str_wrap(x, width = 8))



ggsave("figures/aim_0_real_pseudo_dyads_avg-PFC.png", width = 14, height = 10)
```

#### DLPFC

```{r}
synchrony_data %>%
  ggplot(., aes(x = category, y = DLPFC_avg_score, fill = category, col = category)) +
  geom_flat_violin(position = position_nudge(x = .2, y = 0), alpha = .2, adjust = 4) +
  geom_point(position = position_jitter(width = .10), size = 1, alpha = 0.4) +
  scale_fill_brewer(palette = "Dark2") +
  scale_colour_brewer(palette = "Dark2") +
  guides(fill = FALSE, col = FALSE) +
  geom_boxplot(aes(x = as.numeric(category) + 0.25, y = DLPFC_avg_score), outlier.shape = NA, alpha = 0.4, width = .1, colour = "BLACK") +
  ylab("Synchrony Values (DLPFC)") +
  xlab("Dyads Type") +
  stat_summary(fun.data = "mean_cl_normal", geom = "errorbar", width = 1 / 4, color = "black") +
  stat_summary(fun = "mean", geom = "point", color = "black") +
  theme_apa() +
  facet_wrap(~new_block, nrow = 1) +
  theme(text = element_text(size = 20)) +
  scale_x_discrete(labels = function(x) str_wrap(x, width = 8))

ggsave("figures/aim_0_real_pseudo_dyads_avg-DLPFC.png", width = 14, height = 10)
```
#### VLPFC

```{r}
synchrony_data %>%
  ggplot(., aes(x = category, y = VLPFC_avg_score, fill = category, col = category)) +
  geom_flat_violin(position = position_nudge(x = .2, y = 0), alpha = .2, adjust = 4) +
  geom_point(position = position_jitter(width = .10), size = 1, alpha = 0.4) +
  scale_fill_brewer(palette = "Dark2") +
  scale_colour_brewer(palette = "Dark2") +
  guides(fill = FALSE, col = FALSE) +
  geom_boxplot(aes(x = as.numeric(category) + 0.25, y = VLPFC_avg_score), outlier.shape = NA, alpha = 0.4, width = .1, colour = "BLACK") +
  ylab("Synchrony Values (VLPFC)") +
  xlab("Dyads Type") +
  stat_summary(fun.data = "mean_cl_normal", geom = "errorbar", width = 1 / 4, color = "black") +
  stat_summary(fun = "mean", geom = "point", color = "black") +
  theme_apa() +
  facet_wrap(~new_block, nrow = 1) +
  theme(text = element_text(size = 20)) +
  scale_x_discrete(labels = function(x) str_wrap(x, width = 8))

ggsave("figures/aim_0_real_pseudo_dyads_avg-VLPFC.png", width = 14, height = 10)
```

### Model Testing Pseudo and real dyads
```{r}
synchrony_data_per_trial$block <- factor(synchrony_data_per_trial$block, levels = c("Block 2", "Block 1", "Block 3"))

synchrony_data_per_trial <- synchrony_data_per_trial %>%
  mutate(new_id = paste0(parent, child))


model1 <- lmer(
  avg_score ~ category +
    (1 + block | record_id) + (1 | trial),
  data = synchrony_data_per_trial,
  control = lmerControl(
    optimizer = "bobyqa",
    optCtrl = list(maxfun = 5e5)
  )
)

summary(model1)
report(model1)
```
#### Table Summary
```{r}
modelsummary_1 <- list(
  "Full Model" = model1
)

msummary(modelsummary_1,
  output = "tables/aim_0.docx",
  stars = TRUE, align = "lc", metrics = c("RMSE", "R2", "AIC", "BIC", "Log.Lik.", "F")
)
```

### Sum of blank channels
```{r}
synchrony_data %>%
  filter(category == "Real Dyads") %>%
  dplyr::mutate(across(c("s1_d1_hbo":"s8_d4_hbo"), as.numeric)) %>%
  rowwise() %>%
  mutate(num_na = sum(is.na(c_across(s1_d1_hbo:s8_d4_hbo)))) %>%
  group_by(block) %>%
  summarise(num_na = sum(num_na, na.rm = TRUE)) %>%
  ungroup()
```

```{r}
nirs_plus_qst$block <- factor(nirs_plus_qst$block, levels = c("Block 2", "Block 1", "Block 3"))
nirs_plus_qst <- nirs_plus_qst %>%
  mutate(
    block_2 = case_when(
      block == "Block 1" ~ 1,
      block == "Block 2" ~ 2,
      block == "Block 3" ~ 3
    ),
    block_sq = block_2^2
  )


nirs_plus_qst <- nirs_plus_qst %>%
  mutate(lab = case_when(
    record_id >= 1200 ~ 0,
    TRUE ~ 1
  ))
```

### Breaking apart datasets
```{r}
block1 <- nirs_plus_qst %>%
  filter(block == "Block 1")

block2 <- nirs_plus_qst %>%
  filter(block == "Block 2")

block3 <- nirs_plus_qst %>%
  filter(block == "Block 3")
```

## Correlations
p-values(0, 0.001, 0.01, 0.05, 0.1, 1) <=> symbols(“***”, “**”, “*”, “.”, " “)


```{r}
correlation_df <- block1 %>%
  select(stai_trait, stai_state, cbq_effortful_control, cbq_negative_affectivity, cbq_surgency, cbq_fear, anxiety_c)

chart.Correlation(correlation_df, histogram = TRUE, method = "pearson")
```
### Correlations-block 1 neuro
```{r}
correlation_df <- block1 %>%
  select(stai_trait, stai_state, cbq_effortful_control, cbq_negative_affectivity, cbq_surgency, cbq_fear, anxiety_c, avg_score, DLPFC_avg_score, VLPFC_avg_score)

chart.Correlation(correlation_df, histogram = TRUE, method = "pearson")
```
### Correlations-block 2 neuro
```{r}
correlation_df <- block2 %>%
  select(stai_trait, stai_state, cbq_effortful_control, cbq_negative_affectivity, cbq_surgency, cbq_fear, anxiety_c, avg_score, DLPFC_avg_score, VLPFC_avg_score)

chart.Correlation(correlation_df, histogram = TRUE, method = "pearson")
```
### Correlations-block 3 neuro
```{r}
correlation_df <- block3 %>%
  select(stai_trait, stai_state, cbq_effortful_control, cbq_negative_affectivity, cbq_surgency, cbq_fear, anxiety_c, avg_score, DLPFC_avg_score, VLPFC_avg_score)

chart.Correlation(correlation_df, histogram = TRUE, method = "pearson")
```
### Multilevel Correlations
```{r}
mutilevel_cor_data <- nirs_per_trial_plus_qst %>%
  select(block, trial, cbq_fear, cbq_effortful_control, anxiety_c, stai_state, stai_trait, avg_score, DLPFC_avg_score, VLPFC_avg_score) %>%
  mutate(
    block = as_factor(block),
    trial = as_factor(trial)
  )

correlation::correlation(mutilevel_cor_data, multilevel = TRUE)
```
## Cronbach Alphas for questionnaires

### STAI
```{r}
# upload the datasets
raw_data <- read_csv("questionnaires/input/PCATR56_DATA_2024-03-05_1048.csv") %>%
  janitor::clean_names()
stai_items <- read_csv("questionnaires/input/stai_items.csv") %>%
  janitor::clean_names()

a <- raw_data %>%
  filter(redcap_event_name == "pcat_arm_1" | redcap_event_name == "pcat_arm_4") %>%
  select(record_id, stai1:stai40) %>%
  pivot_longer(cols = stai1:stai40, names_to = "item", values_to = "stai_score") %>%
  right_join(stai_items) %>%
  filter(stai_type == "stai_state") %>%
  mutate(stai_score_r = case_when(
    stai_score < 0 ~ NA_real_,
    action == "reverse" ~ 5 - stai_score,
    TRUE ~ stai_score
  )) %>%
  select(record_id, item, stai_score_r) %>%
  pivot_wider(names_from = item, values_from = stai_score_r) %>%
  right_join(nirs_records) %>%
  select(-record_id) %>%
  filter(across(everything(), ~ !is.na(.)))

# calculate cronbach's alpha
# cronbach.alpha(a, CI=TRUE, standardized=TRUE)

b <- raw_data %>%
  filter(redcap_event_name == "pcat_arm_1" | redcap_event_name == "pcat_arm_4") %>%
  select(record_id, stai1:stai40) %>%
  pivot_longer(cols = stai1:stai40, names_to = "item", values_to = "stai_score") %>%
  right_join(stai_items) %>%
  filter(stai_type == "stai_trait") %>%
  mutate(stai_score_r = case_when(
    stai_score < 0 ~ NA_real_,
    action == "reverse" ~ 5 - stai_score,
    TRUE ~ stai_score
  )) %>%
  select(record_id, item, stai_score_r) %>%
  pivot_wider(names_from = item, values_from = stai_score_r) %>%
  right_join(nirs_records) %>%
  select(-record_id) %>%
  filter(across(everything(), ~ !is.na(.)))
# calculate cronbach's alpha
# cronbach.alpha(b, CI=TRUE, standardized=TRUE)

# remove dfs I won't need again
rm("a", "b", "stai_data", "stai_items")
```

### Child Anxiety
```{r}
c <- hbq_data_overall %>%
  right_join(nirs_records) %>%
  select(-record_id, -anxiety_c)

# calculate cronbach's alpha
# cronbach.alpha(c, CI=TRUE, standardized=TRUE)

# remove dfs I won't need again
rm("c", "hbq_data_overall")
```
### CBQ Fear and Effortful Control
```{r}
cbq_items <- read_csv("questionnaires/input/cbq_items.csv") %>%
  janitor::clean_names()

d <- raw_data %>%
  filter(redcap_event_name == "pcat_arm_1" | redcap_event_name == "pcat_arm_4") %>%
  select(record_id, cbq_1:cbq_94) %>%
  pivot_longer(cols = cbq_1:cbq_94, names_to = "item", values_to = "cbq_score") %>%
  right_join(cbq_items) %>%
  select(-c("question")) %>%
  mutate(cbq_score_r = case_when(
    cbq_score < 0 ~ NA_real_,
    action == "reverse" ~ 8 - cbq_score,
    TRUE ~ cbq_score
  )) %>%
  group_by(record_id, subscale) %>%
  filter(subscale == "fear") %>%
  filter(!is.na(subscale)) %>%
  mutate(cbq_score_r = case_when(
    cbq_score_r == 0 ~ NA_real_,
    TRUE ~ cbq_score_r
  )) %>%
  ungroup() %>%
  select(-c(action, subscale, factor_group, additional_calc, cbq_score)) %>%
  pivot_wider(names_from = item, values_from = cbq_score_r) %>%
  right_join(nirs_records) %>%
  select(-record_id) %>%
  filter(across(everything(), ~ !is.na(.)))

# calculate cronbach's alpha
# cronbach.alpha(d, CI=TRUE, standardized=TRUE)

e <- raw_data %>%
  filter(redcap_event_name == "pcat_arm_1" | redcap_event_name == "pcat_arm_4") %>%
  select(record_id, cbq_1:cbq_94) %>%
  pivot_longer(cols = cbq_1:cbq_94, names_to = "item", values_to = "cbq_score") %>%
  right_join(cbq_items) %>%
  select(-c("question")) %>%
  mutate(cbq_score_r = case_when(
    cbq_score < 0 ~ NA_real_,
    action == "reverse" ~ 8 - cbq_score,
    TRUE ~ cbq_score
  )) %>%
  group_by(record_id, factor_group) %>%
  filter(factor_group == "effortful_control") %>%
  filter(!is.na(factor_group)) %>%
  mutate(cbq_score_r = case_when(
    cbq_score_r == 0 ~ NA_real_,
    TRUE ~ cbq_score_r
  )) %>%
  ungroup() %>%
  select(-c(action, subscale, factor_group, additional_calc, cbq_score)) %>%
  pivot_wider(names_from = item, values_from = cbq_score_r) %>%
  right_join(nirs_records) %>%
  select(-record_id) %>%
  filter(across(everything(), ~ !is.na(.)))

# calculate cronbach's alpha
# cronbach.alpha(e, CI=TRUE, standardized=TRUE)

# remove dfs I won't need again
rm("e", "d")
```


## Lab Comparisons

there is no significant interaction between lab and blocks. Only a marginal effect for Lab variable (p = .06) With Washu families having greater synchrony scores than Penn State
```{r}
model0 <- lmer(avg_score ~ site + (1 + block | record_id) + (1 | trial),
  data = nirs_per_trial_plus_qst,
  control = lmerControl(
    optimizer = "bobyqa",
    optCtrl = list(maxfun = 5e5)
  )
)
summary(model0)
report(model0)

model00 <- lmer(DLPFC_avg_score ~ site + (1 + block | record_id) + (1 | trial),
  data = nirs_per_trial_plus_qst,
  control = lmerControl(
    optimizer = "bobyqa",
    optCtrl = list(maxfun = 5e5)
  )
)
summary(model00)
report(model00)


model000 <- lmer(avg_score ~ site + (1 + block | record_id) + (1 | trial),
  data = nirs_per_trial_plus_qst,
  control = lmerControl(
    optimizer = "bobyqa",
    optCtrl = list(maxfun = 5e5)
  )
)
summary(model000)
report(model000)
```

## 1. Aim 1: To examine parent-child neural synchrony using the DBDOS BioSync version

### Main Models

#### PFC
```{r}
nirs_per_trial_plus_qst$block <- factor(nirs_per_trial_plus_qst$block, levels = c("Block 2", "Block 1", "Block 3"))

model1 <- lmer(
  avg_score ~
    c_age_y_centered + block + c_sex + (1 + block | record_id) + (1 | trial),
  data = nirs_per_trial_plus_qst,
  control = lmerControl(
    optimizer = "bobyqa",
    optCtrl = list(maxfun = 5e5)
  )
)
summary(model1)
report(model1)

performance::check_outliers(model1)
```

#### DLPFC
```{r}
nirs_per_trial_plus_qst$block <- factor(nirs_per_trial_plus_qst$block, levels = c("Block 2", "Block 1", "Block 3"))

model2 <- lmer(
  DLPFC_avg_score ~
    c_age_y_centered + block + c_sex + (1 + block | record_id) + (1 | trial),
  data = nirs_per_trial_plus_qst,
  control = lmerControl(
    optimizer = "bobyqa",
    optCtrl = list(maxfun = 5e5)
  )
)

summary(model2)
report(model2)

performance::check_outliers(model2)
```

#### VLPFC
```{r}
nirs_per_trial_plus_qst$block <- factor(nirs_per_trial_plus_qst$block, levels = c("Block 2", "Block 1", "Block 3"))

model3 <- lmer(
  VLPFC_avg_score ~
    c_age_y_centered + block + c_sex + (1 + block | record_id) + (1 | trial),
  data = nirs_per_trial_plus_qst,
  control = lmerControl(
    optimizer = "bobyqa",
    optCtrl = list(maxfun = 5e5)
  )
)

summary(model3)
report(model3)

performance::check_outliers(model3)
```

### PFC Graph

```{r}
synchrony_data$block <- factor(synchrony_data$block, levels = c("Block 1", "Block 2", "Block 3"))

synchrony_data %>%
  filter(category == "Real Dyads") %>%
  ggplot(., aes(x = new_block, y = avg_score, fill = block, col = block)) +
  scale_color_manual(
    name = "Block Type",
    values = c("#C85729", "#127088", "#92874B")
  ) +
  scale_fill_manual(
    name = "Block Type",
    values = c("#C85729", "#127088", "#92874B")
  ) +
  guides(fill = FALSE, col = FALSE) +
  geom_rain(alpha = .5, rain.side = "f2x2", id.long.var = "record_id") +
  ylab("Neural Synchrony Values (PFC)") +
  xlab("Block Type") +
  stat_summary(fun.data = "mean_cl_normal", geom = "errorbar", width = 1 / 4, color = "black") +
  stat_summary(fun = "mean", geom = "point", color = "black") +
  theme_apa() +
  theme(text = element_text(size = 15))


ggsave("figures/aim_1_block_synchrony_PFC.png", width = 7, height = 5)
```
### DLPFC Graph

```{r}
synchrony_data %>%
  filter(category == "Real Dyads") %>%
  ggplot(., aes(x = block, y = DLPFC_avg_score, fill = block, col = block)) +
  scale_color_manual(
    name = "Block Type",
    values = c("#C85729", "#127088", "#92874B")
  ) +
  scale_fill_manual(
    name = "Block Type",
    values = c("#C85729", "#127088", "#92874B")
  ) +
  guides(fill = FALSE, col = FALSE) +
  geom_rain(alpha = .5, rain.side = "f2x2", id.long.var = "record_id") +
  ylab("Neural Synchrony Values (DLPFC)") +
  xlab("Play Block") +
  stat_summary(fun.data = "mean_cl_normal", geom = "errorbar", width = 1 / 4, color = "black") +
  stat_summary(fun = "mean", geom = "point", color = "black") +
  theme_apa() +
  theme(text = element_text(size = 15))


ggsave("figures/aim_1_block_synchrony_DLPFC.png", width = 7, height = 5)
```
### VLPFC Graph

```{r}
synchrony_data %>%
  filter(category == "Real Dyads") %>%
  ggplot(., aes(x = block, y = VLPFC_avg_score, fill = block, col = block)) +
  scale_color_manual(
    name = "Block Type",
    values = c("#C85729", "#127088", "#92874B")
  ) +
  scale_fill_manual(
    name = "Block Type",
    values = c("#C85729", "#127088", "#92874B")
  ) +
  guides(fill = FALSE, col = FALSE) +
  geom_rain(alpha = .5, rain.side = "f2x2", id.long.var = "record_id") +
  ylab("Neural Synchrony Values (VLPFC)") +
  xlab("Play Block") +
  stat_summary(fun.data = "mean_cl_normal", geom = "errorbar", width = 1 / 4, color = "black") +
  stat_summary(fun = "mean", geom = "point", color = "black") +
  theme_apa() +
  theme(text = element_text(size = 15))


ggsave("figures/aim_1_block_synchrony_VLPFC.png", width = 7, height = 5)
```
### Graph per Trial
Block 1:
- Trial 1: Markers (fine)
- Trial 2: Markers (dots)
- Trial 3: Stickers (shapes)
- Trial 4: Stickers (strips)

Block 2:
- Trial 1: Puzzle set 1
- Trial 2: Puzzle set 2
- Trial 3: Puzzle set 3
- Trial 4: Puzzle set 4

Block 3:
- Trial 1: Magnatiles
- Trial 2: Human and Animal connectors
- Trial 3: Animals, trees, and fences
- Trial 4: Cars, trucks

```{r}
synchrony_data_per_trial$trial <- as.factor(synchrony_data_per_trial$trial)
synchrony_data_per_trial$block <- as.factor(synchrony_data_per_trial$block)

synchrony_data_per_trial$block <- factor(synchrony_data_per_trial$block, levels = c("Block 1", "Block 2", "Block 3"))

synchrony_data_per_trial %>%
  filter(category == "Real Dyads") %>%
  ggplot(., aes(x = trial, y = avg_score, fill = trial, col = trial)) +
  scale_fill_brewer(palette = "Dark2") +
  scale_colour_brewer(palette = "Dark2") +
  guides(fill = FALSE, col = FALSE) +
  geom_rain(alpha = .5, rain.side = "l", id.long.var = "record_id") +
  ylab("Neural Synchrony Values") +
  xlab("Play Block") +
  stat_summary(fun.data = "mean_cl_normal", geom = "errorbar", width = 1 / 4, color = "black", na.rm = TRUE) +
  stat_summary(fun = "mean", geom = "point", color = "black", na.rm = TRUE) +
  theme_apa() +
  theme(text = element_text(size = 20)) +
  facet_wrap(~block) +
  scale_y_continuous(limits = c(0.20, .6), breaks = seq(0.20, .6, by = 0.10)) # Setting Y-axis limits and ticks

ggsave("figures/aim_1_block_synchrony_per-trial_PFC.png", width = 14, height = 10)


not_in_stream_df <- synchrony_data_per_trial %>%
  filter(category == "Real Dyads") %>%
  select(record_id, block, trial, DLPFC_avg_score) %>%
  pivot_wider(
    names_from = trial,
    values_from = DLPFC_avg_score
  ) %>%
  rowwise() %>%
  mutate(
    pattern_found = check_sequence(c(`Trial 1`, `Trial 2`, `Trial 3`, `Trial 4`)),
    pattern_found = case_when(
      sum(is.na(c(`Trial 1`, `Trial 2`, `Trial 3`, `Trial 4`))) == 3 ~ TRUE,
      TRUE ~ pattern_found
    )
  ) %>%
  ungroup() %>%
  filter(pattern_found) %>%
  pivot_longer(cols = c("Trial 1":"Trial 4"), values_to = "DLPFC_avg_score", names_to = "trial") %>%
  filter(!is.na(DLPFC_avg_score))


synchrony_data_per_trial %>%
  filter(category == "Real Dyads") %>%
  ggplot(., aes(x = trial, y = DLPFC_avg_score, fill = trial, col = trial)) +
  scale_fill_brewer(palette = "Dark2") +
  scale_colour_brewer(palette = "Dark2") +
  guides(fill = FALSE, col = FALSE) +
  geom_rain(alpha = .5, rain.side = "l", id.long.var = "record_id") +
  geom_point(data = not_in_stream_df, alpha = .5) +
  ylab("Neural Synchrony Values (DLPFC)") +
  xlab("Play Block") +
  stat_summary(fun.data = "mean_cl_normal", geom = "errorbar", width = 1 / 4, color = "black", na.rm = TRUE) +
  stat_summary(fun = "mean", geom = "point", color = "black", na.rm = TRUE) +
  theme_apa() +
  theme(text = element_text(size = 20)) +
  facet_wrap(~block) +
  scale_y_continuous(limits = c(0.20, .6), breaks = seq(0.20, .6, by = 0.10)) # Setting Y-axis limits and ticks


ggsave("figures/aim_1_block_synchrony_per-trial_DLPFC.png", width = 14, height = 10)

not_in_stream_df <- synchrony_data_per_trial %>%
  filter(category == "Real Dyads") %>%
  select(record_id, block, trial, VLPFC_avg_score) %>%
  pivot_wider(
    names_from = trial,
    values_from = VLPFC_avg_score
  ) %>%
  rowwise() %>%
  mutate(
    pattern_found = check_sequence(c(`Trial 1`, `Trial 2`, `Trial 3`, `Trial 4`)),
    pattern_found = case_when(
      sum(is.na(c(`Trial 1`, `Trial 2`, `Trial 3`, `Trial 4`))) == 3 ~ TRUE,
      TRUE ~ pattern_found
    )
  ) %>%
  ungroup() %>%
  filter(pattern_found) %>%
  pivot_longer(cols = c("Trial 1":"Trial 4"), values_to = "VLPFC_avg_score", names_to = "trial") %>%
  filter(!is.na(VLPFC_avg_score))

synchrony_data_per_trial %>%
  filter(category == "Real Dyads") %>%
  ggplot(., aes(x = trial, y = VLPFC_avg_score, fill = trial, col = trial)) +
  scale_fill_brewer(palette = "Dark2") +
  scale_colour_brewer(palette = "Dark2") +
  guides(fill = FALSE, col = FALSE) +
  geom_rain(alpha = .5, rain.side = "l", id.long.var = "record_id") +
  geom_point(data = not_in_stream_df, alpha = .5) +
  ylab("Neural Synchrony Values (VLPFC)") +
  xlab("Play Block") +
  stat_summary(fun.data = "mean_cl_normal", geom = "errorbar", width = 1 / 4, color = "black") +
  stat_summary(fun = "mean", geom = "point", color = "black") +
  theme_apa() +
  theme(text = element_text(size = 20)) +
  facet_wrap(~block) +
  scale_y_continuous(limits = c(0.20, .6), breaks = seq(0.20, .6, by = 0.10)) # Setting Y-axis limits and ticks


ggsave("figures/aim_1_block_synchrony_per-trial_VLPFC.png", width = 14, height = 10)
```


## Aim 2: To examine the relationship between child temperament and dyadic neural synchrony
### PFC
#### Model -block 2 reference
```{r}
nirs_per_trial_plus_qst$block <- factor(nirs_per_trial_plus_qst$block, levels = c("Block 2", "Block 1", "Block 3"))

model1 <- lmer(
  avg_score ~ c_age_y_centered +
    c_sex + cbq_fear * block + cbq_effortful_control * block + (1 + block | record_id) + (1 | trial),
  data = nirs_per_trial_plus_qst,
  control = lmerControl(
    optimizer = "bobyqa",
    optCtrl = list(maxfun = 5e5)
  )
)

summary(model1)

# emm = emmeans(model1, ~ cbq_effortful_control*block )
# pairs(emm)
# # or for simple comparisons
# #pairs(emm, simple = "each")

anova(model1, type = "III")
report(model1)

performance::check_outliers(model1)

nirs_per_trial_plus_qst$block_numeric <- as.numeric(nirs_per_trial_plus_qst$block)

model1b <- lmer(
  avg_score ~ c_age_y_centered +
    c_sex + cbq_fear * block_numeric + cbq_effortful_control * block_numeric + (1 + block | record_id) + (1 | trial),
  data = nirs_per_trial_plus_qst,
  control = lmerControl(
    optimizer = "bobyqa",
    optCtrl = list(maxfun = 5e5)
  )
)

summary(model1b)
report(model1b)
```

##### Report
```{r}
tab_model(model1, p.val = "kr", show.df = TRUE)
```


#### Simple intercepts and slopes
```{r}
sim_slopes(model1,
  pred = cbq_effortful_control, modx = block, cond.int = TRUE,
  centered = "none", johnson_neyman = FALSE
)
```
```{r}
interact_plot(model1,
  pred = cbq_effortful_control, modx = block,
  x.label = "Effortful Control", y.label = "PFC Synchrony Scores",
  legend.main = "Block"
)
```

#### Plot for interaction: EC*Block

```{r}
interaction_eff1 <- ggpredict(model1, c("cbq_effortful_control", "block"))
interaction_eff1

ggplot(interaction_eff1, aes(x, predicted, color = group)) +
  geom_line(linewidth = 1.2) +
  geom_ribbon(aes(ymin = conf.low, ymax = conf.high, fill = group), alpha = 0.2, color = NA) +
  theme_classic() +
  scale_color_manual(
    name = "Block Type",
    values = natparks.pals("Saguaro", 3),
    labels = c(
      "Block 1" = "Baseline",
      "Block 2" = "Stressful",
      "Block 3" = "Recovery"
    )
  ) +
  scale_fill_manual(
    name = "Block Type",
    values = natparks.pals("Saguaro", 3),
    labels = c(
      "Block 1" = "Baseline",
      "Block 2" = "Stressful",
      "Block 3" = "Recovery"
    )
  ) +
  scale_x_continuous(
    name = "Effortful Control (CBQ scores)"
  ) +
  theme(
    axis.text = element_text(size = 19),
    axis.title = element_text(size = 20),
    legend.text = element_text(size = 19),
    legend.title = element_text(face = "bold", size = 19),
    legend.title.align = 0.5
  ) +
  scale_y_continuous(name = "PFC Neural Synchrony (predicted)", limits = c(0.29, .42), breaks = seq(0.29, .42, by = 0.02)) # Setting Y-axis limits and ticks


ggsave("figures/aim_2_EC-Block_PFC.png", width = 10, height = 8)
```
#### Plot for interaction: F*Block

```{r}
interaction_eff1b <- ggpredict(model1, c("cbq_fear", "block"))
interaction_eff1b

ggplot(interaction_eff1b, aes(x, predicted, color = group)) +
  geom_line(linewidth = 1.2) +
  geom_ribbon(aes(ymin = conf.low, ymax = conf.high, fill = group), alpha = 0.2, color = NA) +
  theme_classic() +
  scale_color_manual(
    name = "Block Type",
    values = natparks.pals("Saguaro", 3),
    labels = c(
      "Block 1" = "Baseline",
      "Block 2" = "Stressful",
      "Block 3" = "Recovery"
    )
  ) +
  scale_fill_manual(
    name = "Block Type",
    values = natparks.pals("Saguaro", 3),
    labels = c(
      "Block 1" = "Baseline",
      "Block 2" = "Stressful",
      "Block 3" = "Recovery"
    )
  ) +
  scale_x_continuous(
    name = "Fear (CBQ scores)"
  ) +
  theme(
    axis.text = element_text(size = 19),
    axis.title = element_text(size = 20),
    legend.text = element_text(size = 19),
    legend.title = element_text(face = "bold", size = 19),
    legend.title.align = 0.5
  ) +
  scale_y_continuous(name = "PFC Neural Synchrony (predicted)", limits = c(0.29, .42), breaks = seq(0.29, .42, by = 0.02)) # Setting Y-axis limits and ticks


ggsave("figures/aim_2_F-Block_PFC.png", width = 10, height = 8)
```
### DLPFC
#### Model-block 2 reference
```{r}
nirs_per_trial_plus_qst$block <- factor(nirs_per_trial_plus_qst$block, levels = c("Block 2", "Block 1", "Block 3"))

model2 <- lmer(
  DLPFC_avg_score ~ c_age_y_centered +
    c_sex + cbq_fear * block + cbq_effortful_control * block + (1 + block | record_id) + (1 | trial),
  data = nirs_per_trial_plus_qst,
  control = lmerControl(
    optimizer = "bobyqa",
    optCtrl = list(maxfun = 5e5)
  )
)

summary(model2)
report(model2)

emm <- emmeans(model2, ~ cbq_effortful_control * block)
pairs(emm)
# or for simple comparisons
# pairs(emm, simple = "each")
```

#### Model-block 3 reference

```{r}
nirs_per_trial_plus_qst$block <- factor(nirs_per_trial_plus_qst$block, levels = c("Block 3", "Block 1", "Block 2"))

model2b <- lmer(
  DLPFC_avg_score ~ c_age_y_centered +
    c_sex + cbq_fear * block + cbq_effortful_control * block + (1 + block | record_id) + (1 | trial),
  data = nirs_per_trial_plus_qst,
  control = lmerControl(
    optimizer = "bobyqa",
    optCtrl = list(maxfun = 5e5)
  )
)

summary(model2b)
report(model2b)

emm <- emmeans(model2b, ~ cbq_effortful_control * block)
pairs(emm)
# or for simple comparisons
# pairs(emm, simple = "each")

report(anova(model2b, type = "III"))
```

#### Simple intercepts & slopes: EC*Block
```{r}
interaction_eff2 <- ggpredict(model2, c("cbq_effortful_control", "block"))
interaction_eff2

ggplot(interaction_eff2, aes(x, predicted, color = group)) +
  geom_line(linewidth = 1.2) +
  geom_ribbon(aes(ymin = conf.low, ymax = conf.high, fill = group), alpha = 0.2, color = NA) +
  theme_classic() +
  scale_color_manual(
    name = "Block Type",
    values = natparks.pals("Saguaro", 3),
    labels = c(
      "Block 1" = "Baseline",
      "Block 2" = "Stressful",
      "Block 3" = "Recovery"
    )
  ) +
  scale_fill_manual(
    name = "Block Type",
    values = natparks.pals("Saguaro", 3),
    labels = c(
      "Block 1" = "Baseline",
      "Block 2" = "Stressful",
      "Block 3" = "Recovery"
    )
  ) +
  scale_x_continuous(
    name = "Effortful Control (CBQ scores)"
  ) +
  theme(
    axis.text = element_text(size = 19),
    axis.title = element_text(size = 20),
    legend.text = element_text(size = 19),
    legend.title = element_text(face = "bold", size = 19),
    legend.title.align = 0.5
  ) +
  scale_y_continuous(name = "DLPFC Neural Synchrony (predicted)", limits = c(0.29, .42), breaks = seq(0.29, .42, by = 0.02)) # Setting Y-axis limits and ticks

ggsave("figures/aim_2_EC-Block_DLPFC.png", width = 10, height = 8)
```

#### Simple intercepts & slopes: F*Block
```{r}
interaction_eff3 <- ggpredict(model2, c("cbq_fear", "block"))
interaction_eff3

ggplot(interaction_eff3, aes(x, predicted, color = group)) +
  geom_line(linewidth = 1.2) +
  geom_ribbon(aes(ymin = conf.low, ymax = conf.high, fill = group), alpha = 0.2, color = NA) +
  theme_classic() +
  scale_color_manual(
    name = "Block Type",
    values = natparks.pals("Saguaro", 3),
    labels = c(
      "Block 1" = "Baseline",
      "Block 2" = "Stressful",
      "Block 3" = "Recovery"
    )
  ) +
  scale_fill_manual(
    name = "Block Type",
    values = natparks.pals("Saguaro", 3),
    labels = c(
      "Block 1" = "Baseline",
      "Block 2" = "Stressful",
      "Block 3" = "Recovery"
    )
  ) +
  scale_x_continuous(
    name = "Fear (CBQ scores)"
  ) +
  theme(
    axis.text = element_text(size = 19),
    axis.title = element_text(size = 20),
    legend.text = element_text(size = 19),
    legend.title = element_text(face = "bold", size = 19),
    legend.title.align = 0.5
  ) +
  scale_y_continuous(name = "DLPFC Neural Synchrony (predicted)", limits = c(0.29, .42), breaks = seq(0.29, .42, by = 0.02)) # Setting Y-axis limits and ticks


ggsave("figures/aim_2_F-Block_DLPFC.png", width = 10, height = 8)
```
### VLPFC
#### Model
```{r}
nirs_per_trial_plus_qst$block <- factor(nirs_per_trial_plus_qst$block, levels = c("Block 2", "Block 1", "Block 3"))

model3 <- lmer(
  VLPFC_avg_score ~ c_age_y_centered +
    c_sex + cbq_fear * block + cbq_effortful_control * block + (1 + block | record_id) + (1 | trial),
  data = nirs_per_trial_plus_qst,
  control = lmerControl(
    optimizer = "bobyqa",
    optCtrl = list(maxfun = 5e5)
  )
)

summary(model3)

emm <- emmeans(model3, ~ cbq_effortful_control * block)
pairs(emm)
# or for simple comparisons
# pairs(emm, simple = "each")

emm <- emmeans(model3, ~ cbq_fear * block)
pairs(emm)

report(model3)
```
#### Simple intercepts & slops: EC*Block
```{r}
interaction_eff4 <- ggpredict(model3, c("cbq_effortful_control", "block"))
interaction_eff4

ggplot(interaction_eff4, aes(x, predicted, color = group)) +
  geom_line(linewidth = 1.2) +
  geom_ribbon(aes(ymin = conf.low, ymax = conf.high, fill = group), alpha = 0.2, color = NA) +
  theme_classic() +
  scale_color_manual(
    name = "Block Type",
    values = natparks.pals("Saguaro", 3),
    labels = c(
      "Block 1" = "Baseline",
      "Block 2" = "Stressful",
      "Block 3" = "Recovery"
    )
  ) +
  scale_fill_manual(
    name = "Block Type",
    values = natparks.pals("Saguaro", 3),
    labels = c(
      "Block 1" = "Baseline",
      "Block 2" = "Stressful",
      "Block 3" = "Recovery"
    )
  ) +
  scale_x_continuous(
    name = "Effortful Control (CBQ scores)"
  ) +
  theme(
    axis.text = element_text(size = 19),
    axis.title = element_text(size = 20),
    legend.text = element_text(size = 19),
    legend.title = element_text(face = "bold", size = 19),
    legend.title.align = 0.5
  ) +
  scale_y_continuous(name = "VLPFC Neural Synchrony (predicted)", limits = c(0.29, .42), breaks = seq(0.29, .42, by = 0.02)) # Setting Y-axis limits and ticks


ggsave("figures/aim_2_EC-Block_VLPFC.png.png", width = 10, height = 8)
```

#### Simple intercepts & slopes: F*Block
```{r}
interaction_eff5 <- ggpredict(model3, c("cbq_fear", "block"))
interaction_eff5

ggplot(interaction_eff5, aes(x, predicted, color = group)) +
  geom_line(linewidth = 1.2) +
  geom_ribbon(aes(ymin = conf.low, ymax = conf.high, fill = group), alpha = 0.2, color = NA) +
  theme_classic() +
  scale_color_manual(
    name = "Block Type",
    values = natparks.pals("Saguaro", 3),
    labels = c(
      "Block 1" = "Baseline",
      "Block 2" = "Stressful",
      "Block 3" = "Recovery"
    )
  ) +
  scale_fill_manual(
    name = "Block Type",
    values = natparks.pals("Saguaro", 3),
    labels = c(
      "Block 1" = "Baseline",
      "Block 2" = "Stressful",
      "Block 3" = "Recovery"
    )
  ) +
  scale_x_continuous(
    name = "Fear (CBQ scores)"
  ) +
  theme(
    axis.text = element_text(size = 19),
    axis.title = element_text(size = 20),
    legend.text = element_text(size = 19),
    legend.title = element_text(face = "bold", size = 19),
    legend.title.align = 0.5
  ) +
  scale_y_continuous(name = "VLPFC Neural Synchrony (predicted)", limits = c(0.29, .42), breaks = seq(0.29, .42, by = 0.02)) # Setting Y-axis limits and ticks


ggsave("figures/aim_2_F-Block_VLPFC.png", width = 10, height = 8)
```
### Report
```{r}
tab_model(model1, model2, model3, p.val = "kr", show.df = TRUE, collapse.ci = TRUE, p.style = "stars", digits = 3)
```

## 3. To examine the relationship between child temperament, anxiety, and dyadic neural synchrony

### Descriptives
```{r}
nirs_per_trial_plus_qst$block <- factor(nirs_per_trial_plus_qst$block, levels = c("Block 1", "Block 2", "Block 3"))

descriptives_a <- nirs_per_trial_plus_qst %>%
  select(record_id, block, trial, avg_score, DLPFC_avg_score, VLPFC_avg_score) %>%
  group_by(block) %>%
  summarise(
    PFC_mean = round(mean(avg_score, na.rm = TRUE), 2),
    DLPFC_mean = round(mean(DLPFC_avg_score, na.rm = TRUE), 2),
    VLPFC_mean = round(mean(VLPFC_avg_score, na.rm = TRUE), 2),
    PFC_sd = round(sd(avg_score, na.rm = TRUE), 2),
    DLPFC_sd = round(sd(DLPFC_avg_score, na.rm = TRUE), 2),
    VLPFC_sd = round(sd(VLPFC_avg_score, na.rm = TRUE), 2),
    PFC_min = round(min(avg_score, na.rm = TRUE), 2),
    DLPFC_min = round(min(DLPFC_avg_score, na.rm = TRUE), 2),
    VLPFC_min = round(min(VLPFC_avg_score, na.rm = TRUE), 2),
    PFC_max = round(max(avg_score, na.rm = TRUE), 2),
    DLPFC_max = round(max(DLPFC_avg_score, na.rm = TRUE), 2),
    VLPFC_max = round(max(VLPFC_avg_score, na.rm = TRUE), 2)
  ) %>%
  ungroup() %>%
  pivot_longer(PFC_mean:VLPFC_max, names_to = c("ROI", "stat"), names_sep = "_", values_to = "value") %>%
  arrange(ROI) %>%
  unite("name", c("ROI", "block"))

block1 %>%
  select(stai_trait, stai_state, cbq_effortful_control, cbq_fear, anxiety_c) %>%
  pivot_longer(stai_trait:anxiety_c, names_to = "name", values_to = "value") %>%
  group_by(name) %>%
  summarize(
    mean = round(mean(value, na.rm = TRUE), 2),
    sd = round(sd(value, na.rm = TRUE), 2),
    min = round(min(value, na.rm = TRUE), 2),
    max = round(max(value, na.rm = TRUE), 2)
  ) %>%
  pivot_longer(mean:max, names_to = "stat", values_to = "value") %>%
  rbind(descriptives_a) %>%
  pivot_wider(names_from = stat, values_from = value) %>%
  mutate(
    "Mean (SD)" = paste0(mean, " (", sd, ")"),
    Range = paste0(min, "-", max),
    name = as.factor(name)
  ) %>%
  select(name, "Mean (SD)", "Range") %>%
  gt()
```

### Correlations
#### Table
```{r}
corr_df <- block1 %>%
  select(stai_trait, stai_state, cbq_effortful_control, cbq_fear, anxiety_c)

# ++++++++++++++++++++++++++++
# flattenCorrMatrix
# ++++++++++++++++++++++++++++
# cormat : matrix of the correlation coefficients
# pmat : matrix of the correlation p-values
flattenCorrMatrix <- function(cormat, pmat) {
  ut <- upper.tri(cormat)
  data.frame(
    row = rownames(cormat)[row(cormat)[ut]],
    column = rownames(cormat)[col(cormat)[ut]],
    cor = round((cormat)[ut], 2),
    p = round(pmat[ut], 6)
  )
}
res2 <- rcorr(as.matrix(corr_df))
res3 <- flattenCorrMatrix(res2$r, res2$P)

res3 %>%
  mutate(test = paste0("r = ", cor, ", p = ", p)) %>%
  select(row, column, test) %>%
  pivot_wider(names_from = column, values_from = test)
```

#### Individual
```{r}
report(cor.test(block1$stai_state, block1$anxiety_c, method = "pearson", conf.level = 0.95))
report(cor.test(block1$stai_state, block1$cbq_effortful_control, method = "pearson", conf.level = 0.95))
report(cor.test(block1$stai_state, block1$cbq_fear, method = "pearson", conf.level = 0.95))
report(cor.test(block1$stai_trait, block1$anxiety_c, method = "pearson", conf.level = 0.95))
report(cor.test(block1$stai_trait, block1$cbq_effortful_control, method = "pearson", conf.level = 0.95))
report(cor.test(block1$stai_trait, block1$cbq_fear, method = "pearson", conf.level = 0.95))
report(cor.test(block1$cbq_fear, block1$cbq_effortful_control, method = "pearson", conf.level = 0.95))
report(cor.test(block1$stai_state, block1$stai_trait, method = "pearson", conf.level = 0.95))
report(cor.test(block1$anxiety_c, block1$cbq_fear, method = "pearson", conf.level = 0.95))
report(cor.test(block1$anxiety_c, block1$cbq_effortful_control, method = "pearson", conf.level = 0.95))
```
### PFC
#### State - Model -block 2 reference
```{r}
nirs_per_trial_plus_qst$block <- factor(nirs_per_trial_plus_qst$block, levels = c("Block 2", "Block 1", "Block 3"))

model3_1 <- lmer(
  avg_score ~ c_age_y_centered +
    c_sex + cbq_fear * block + cbq_effortful_control * block + anxiety_c * block + stai_state * block + (1 + block | record_id) + (1 | trial),
  data = nirs_per_trial_plus_qst,
  control = lmerControl(
    optimizer = "bobyqa",
    optCtrl = list(maxfun = 5e5)
  )
)

summary(model3_1)

# emm = emmeans(model3_1, ~ cbq_effortful_control*block )
# pairs(emm)
# # or for simple comparisons
# #pairs(emm, simple = "each")

anova(model3_1, type = "III")
report(model3_1)

model3_1_x <- lmer(
  avg_score ~ c_age_y_centered +
    c_sex + cbq_fear * block + cbq_effortful_control * block + anxiety_c + stai_state * block + (1 + block | record_id) + (1 | trial),
  data = nirs_per_trial_plus_qst,
  control = lmerControl(
    optimizer = "bobyqa",
    optCtrl = list(maxfun = 5e5)
  )
)
model3_1_y <- lmer(
  avg_score ~ c_age_y_centered +
    c_sex + cbq_fear * block + cbq_effortful_control * block + anxiety_c + stai_state + (1 + block | record_id) + (1 | trial),
  data = nirs_per_trial_plus_qst,
  control = lmerControl(
    optimizer = "bobyqa",
    optCtrl = list(maxfun = 5e5)
  )
)

performance::compare_performance(model3_1, model3_1_x, model3_1_y)

### model_3_1 is the best model <-
```
##### Report
```{r}
tab_model(model3_1, p.val = "kr", show.df = TRUE)
```

##### Plot for interaction: EC

```{r}
interaction_eff3_1 <- ggpredict(model3_1, c("cbq_effortful_control", "block"))
interaction_eff3_1

ggplot(interaction_eff3_1, aes(x, predicted, color = group)) +
  geom_line(linewidth = 1.2) +
  geom_ribbon(aes(ymin = conf.low, ymax = conf.high, fill = group), alpha = 0.2, color = NA) +
  theme_classic() +
  scale_color_manual(
    name = "Block Type",
    values = natparks.pals("Saguaro", 3),
    labels = c(
      "Block 1" = "Baseline",
      "Block 2" = "Stressful",
      "Block 3" = "Recovery"
    )
  ) +
  scale_fill_manual(
    name = "Block Type",
    values = natparks.pals("Saguaro", 3),
    labels = c(
      "Block 1" = "Baseline",
      "Block 2" = "Stressful",
      "Block 3" = "Recovery"
    )
  ) +
  scale_x_continuous(
    name = "Effortful Control (CBQ scores)"
  ) +
  theme(
    axis.text = element_text(size = 19),
    axis.title = element_text(size = 20),
    legend.text = element_text(size = 19),
    legend.title = element_text(face = "bold", size = 19),
    legend.title.align = 0.5
  ) +
  scale_y_continuous(name = "PFC Neural Synchrony (predicted)", limits = c(0.29, .42), breaks = seq(0.29, .42, by = 0.02)) # Setting Y-axis limits and ticks


ggsave("figures/aim_3_EC-Block_state_PFC.png", width = 10, height = 8)
```
#### Trait - Model -block 2 reference
```{r}
nirs_per_trial_plus_qst$block <- factor(nirs_per_trial_plus_qst$block, levels = c("Block 2", "Block 1", "Block 3"))

model3_2 <- lmer(
  avg_score ~ c_age_y_centered +
    c_sex + cbq_fear * block + cbq_effortful_control * block + anxiety_c * block + stai_trait * block +
    (1 + block | record_id) + (1 | trial),
  data = nirs_per_trial_plus_qst,
  control = lmerControl(
    optimizer = "bobyqa",
    optCtrl = list(maxfun = 5e5)
  )
)

summary(model3_2)

# emm = emmeans(model3_2, ~ cbq_effortful_control*block )
# pairs(emm)
# # or for simple comparisons
# #pairs(emm, simple = "each")

anova(model3_2, type = "III")
report(model3_2)

performance::check_outliers(model3_2)

model3_2_x <- lmer(
  avg_score ~ c_age_y_centered +
    c_sex + cbq_fear * block + cbq_effortful_control * block + anxiety_c + stai_trait * block +
    (1 + block | record_id) + (1 | trial),
  data = nirs_per_trial_plus_qst,
  control = lmerControl(
    optimizer = "bobyqa",
    optCtrl = list(maxfun = 5e5)
  )
)
model3_2_y <- lmer(
  avg_score ~ c_age_y_centered +
    c_sex + cbq_fear * block + cbq_effortful_control * block + anxiety_c + stai_trait +
    (1 + block | record_id) + (1 | trial),
  data = nirs_per_trial_plus_qst,
  control = lmerControl(
    optimizer = "bobyqa",
    optCtrl = list(maxfun = 5e5)
  )
)

performance::compare_performance(model3_2, model3_2_x, model3_2_y)
```

##### Plot for interaction: EC

```{r}
interaction_eff3_2 <- ggpredict(model3_2, c("cbq_effortful_control", "block"))
interaction_eff3_2

ggplot(interaction_eff3_2, aes(x, predicted, color = group)) +
  geom_line(linewidth = 1.2) +
  geom_ribbon(aes(ymin = conf.low, ymax = conf.high, fill = group), alpha = 0.2, color = NA) +
  theme_classic() +
  scale_color_manual(
    name = "Block Type",
    values = natparks.pals("Saguaro", 3),
    labels = c(
      "Block 1" = "Baseline",
      "Block 2" = "Stressful",
      "Block 3" = "Recovery"
    )
  ) +
  scale_fill_manual(
    name = "Block Type",
    values = natparks.pals("Saguaro", 3),
    labels = c(
      "Block 1" = "Baseline",
      "Block 2" = "Stressful",
      "Block 3" = "Recovery"
    )
  ) +
  scale_x_continuous(
    name = "Effortful Control (CBQ scores)"
  ) +
  theme(
    axis.text = element_text(size = 19),
    axis.title = element_text(size = 20),
    legend.text = element_text(size = 19),
    legend.title = element_text(face = "bold", size = 19),
    legend.title.align = 0.5
  ) +
  scale_y_continuous(name = "PFC Neural Synchrony (predicted)", limits = c(0.29, .42), breaks = seq(0.29, .42, by = 0.02)) # Setting Y-axis limits and ticks


ggsave("figures/aim_3_EC-Block_trait_PFC.png", width = 10, height = 8)
```

### DLPFC
#### State - Model -block 2 reference
```{r}
nirs_per_trial_plus_qst$block <- factor(nirs_per_trial_plus_qst$block, levels = c("Block 2", "Block 1", "Block 3"))

model3_3 <- lmer(
  DLPFC_avg_score ~ c_age_y_centered +
    c_sex + cbq_fear * block + cbq_effortful_control * block + anxiety_c * block + stai_state * block
    + (1 + block | record_id) + (1 | trial),
  data = nirs_per_trial_plus_qst,
  control = lmerControl(
    optimizer = "bobyqa",
    optCtrl = list(maxfun = 5e5)
  )
)

summary(model3_3)

# emm = emmeans(model3_3, ~ cbq_effortful_control*block )
# pairs(emm)
# # or for simple comparisons
# #pairs(emm, simple = "each")

anova(model3_3, type = "III")
report(model3_3)

model3_3_x <- lmer(
  DLPFC_avg_score ~ c_age_y_centered +
    c_sex + cbq_fear * block + cbq_effortful_control * block + anxiety_c + stai_state * block +
    (1 + block | record_id) + (1 | trial),
  data = nirs_per_trial_plus_qst,
  control = lmerControl(
    optimizer = "bobyqa",
    optCtrl = list(maxfun = 5e5)
  )
)

model3_3_y <- lmer(
  DLPFC_avg_score ~ c_age_y_centered +
    c_sex + cbq_fear * block + cbq_effortful_control * block + anxiety_c + stai_state +
    (1 + block | record_id) + (1 | trial),
  data = nirs_per_trial_plus_qst,
  control = lmerControl(
    optimizer = "bobyqa",
    optCtrl = list(maxfun = 5e5)
  )
)

performance::compare_performance(model3_3, model3_3_x, model3_3_y)

## best model is model3_3
```

##### Plot for interaction: Fear

```{r}
interaction_eff3_3 <- ggpredict(model3_3, c("cbq_fear", "block"))
interaction_eff3_3

ggplot(interaction_eff3_3, aes(x, predicted, color = group)) +
  geom_line(linewidth = 1.2) +
  geom_ribbon(aes(ymin = conf.low, ymax = conf.high, fill = group), alpha = 0.2, color = NA) +
  theme_classic() +
  scale_color_manual(
    name = "Block Type",
    values = natparks.pals("Saguaro", 3),
    labels = c(
      "Block 1" = "Baseline",
      "Block 2" = "Stressful",
      "Block 3" = "Recovery"
    )
  ) +
  scale_fill_manual(
    name = "Block Type",
    values = natparks.pals("Saguaro", 3),
    labels = c(
      "Block 1" = "Baseline",
      "Block 2" = "Stressful",
      "Block 3" = "Recovery"
    )
  ) +
  scale_x_continuous(
    name = "Fear (CBQ scores)"
  ) +
  theme(
    axis.text = element_text(size = 19),
    axis.title = element_text(size = 20),
    legend.text = element_text(size = 19),
    legend.title = element_text(face = "bold", size = 19),
    legend.title.align = 0.5
  ) +
  scale_y_continuous(name = "DLPFC Neural Synchrony (predicted)", limits = c(0.29, .42), breaks = seq(0.29, .42, by = 0.02)) # Setting Y-axis limits and ticks


ggsave("figures/aim_3_F-Block_state_DLPFC.png", width = 10, height = 8)
```

#### Trait - Model -block 2 reference
```{r}
nirs_per_trial_plus_qst$block <- factor(nirs_per_trial_plus_qst$block, levels = c("Block 2", "Block 1", "Block 3"))

model3_4 <- lmer(
  DLPFC_avg_score ~ c_age_y_centered +
    c_sex + cbq_fear * block + cbq_effortful_control * block + anxiety_c * block + stai_trait * block + (1 + block | record_id) + (1 | trial),
  data = nirs_per_trial_plus_qst,
  control = lmerControl(
    optimizer = "bobyqa",
    optCtrl = list(maxfun = 5e5)
  )
)

summary(model3_4)

# emm = emmeans(model3_4, ~ cbq_effortful_control*block )
# pairs(emm)
# # or for simple comparisons
# #pairs(emm, simple = "each")

anova(model3_4, type = "III")
report(model3_4)

performance::check_outliers(model3_4)


model3_4_x <- lmer(
  DLPFC_avg_score ~ c_age_y_centered +
    c_sex + cbq_fear * block + cbq_effortful_control * block + anxiety_c + stai_trait * block +
    (1 + block | record_id) + (1 | trial),
  data = nirs_per_trial_plus_qst,
  control = lmerControl(
    optimizer = "bobyqa",
    optCtrl = list(maxfun = 5e5)
  )
)

model3_4_y <- lmer(
  DLPFC_avg_score ~ c_age_y_centered +
    c_sex + cbq_fear * block + cbq_effortful_control * block + anxiety_c + stai_trait +
    (1 + block | record_id) + (1 | trial),
  data = nirs_per_trial_plus_qst,
  control = lmerControl(
    optimizer = "bobyqa",
    optCtrl = list(maxfun = 5e5)
  )
)

performance::compare_performance(model3_4, model3_4_x, model3_4_y)
```

#### Trait - Model -block 3 reference
```{r}
nirs_per_trial_plus_qst$block <- factor(nirs_per_trial_plus_qst$block, levels = c("Block 3", "Block 1", "Block 2"))

model3_4b <- lmer(
  DLPFC_avg_score ~ c_age_y_centered +
    c_sex + cbq_fear * block + cbq_effortful_control * block + anxiety_c * block + stai_trait * block + (1 + block | record_id) + (1 | trial),
  data = nirs_per_trial_plus_qst,
  control = lmerControl(
    optimizer = "bobyqa",
    optCtrl = list(maxfun = 5e5)
  )
)

summary(model3_4b)

# emm = emmeans(model3_4, ~ cbq_effortful_control*block )
# pairs(emm)
# # or for simple comparisons
# #pairs(emm, simple = "each")

anova(model3_4b, type = "III")
report(model3_4b)
```

##### Plot for interaction: Fear

```{r}
interaction_eff3_4 <- ggpredict(model3_4, c("cbq_fear", "block"))
interaction_eff3_4

ggplot(interaction_eff3_4, aes(x, predicted, color = group)) +
  geom_line(linewidth = 1.2) +
  geom_ribbon(aes(ymin = conf.low, ymax = conf.high, fill = group), alpha = 0.2, color = NA) +
  theme_classic() +
  scale_color_manual(
    name = "Block Type",
    values = natparks.pals("Saguaro", 3),
    labels = c(
      "Block 1" = "Baseline",
      "Block 2" = "Stressful",
      "Block 3" = "Recovery"
    )
  ) +
  scale_fill_manual(
    name = "Block Type",
    values = natparks.pals("Saguaro", 3),
    labels = c(
      "Block 1" = "Baseline",
      "Block 2" = "Stressful",
      "Block 3" = "Recovery"
    )
  ) +
  scale_x_continuous(
    name = "Fear (CBQ scores)"
  ) +
  theme(
    axis.text = element_text(size = 19),
    axis.title = element_text(size = 20),
    legend.text = element_text(size = 19),
    legend.title = element_text(face = "bold", size = 19),
    legend.title.align = 0.5
  ) +
  scale_y_continuous(name = "DLPFC Neural Synchrony (predicted)", limits = c(0.29, .42), breaks = seq(0.29, .42, by = 0.02)) # Setting Y-axis limits and ticks


ggsave("figures/aim_3_F-Block_trait_DLPFC.png", width = 10, height = 8)
```
##### Plot for interaction: EC

```{r}
interaction_eff3_4_b <- ggpredict(model3_4, c("cbq_effortful_control", "block"))
interaction_eff3_4_b

ggplot(interaction_eff3_4_b, aes(x, predicted, color = group)) +
  geom_line(linewidth = 1.2) +
  geom_ribbon(aes(ymin = conf.low, ymax = conf.high, fill = group), alpha = 0.2, color = NA) +
  theme_classic() +
  scale_color_manual(
    name = "Block Type",
    values = natparks.pals("Saguaro", 3),
    labels = c(
      "Block 1" = "Baseline",
      "Block 2" = "Stressful",
      "Block 3" = "Recovery"
    )
  ) +
  scale_fill_manual(
    name = "Block Type",
    values = natparks.pals("Saguaro", 3),
    labels = c(
      "Block 1" = "Baseline",
      "Block 2" = "Stressful",
      "Block 3" = "Recovery"
    )
  ) +
  scale_x_continuous(
    name = "Effortful Control (CBQ scores)"
  ) +
  theme(
    axis.text = element_text(size = 19),
    axis.title = element_text(size = 20),
    legend.text = element_text(size = 19),
    legend.title = element_text(face = "bold", size = 19),
    legend.title.align = 0.5
  ) +
  scale_y_continuous(name = "DLPFC Neural Synchrony (predicted)", limits = c(0.29, .42), breaks = seq(0.29, .42, by = 0.02)) # Setting Y-axis limits and ticks


ggsave("figures/aim_3_EC-Block_trait_DLPFC.png", width = 10, height = 8)
```
### VLPFC
#### State - Model -block 2 reference
```{r}
nirs_per_trial_plus_qst$block <- factor(nirs_per_trial_plus_qst$block, levels = c("Block 2", "Block 1", "Block 3"))

model3_5 <- lmer(
  VLPFC_avg_score ~ c_age_y_centered +
    c_sex + cbq_fear * block + cbq_effortful_control * block + anxiety_c * block + stai_state * block +
    (1 + block | record_id) + (1 | trial),
  data = nirs_per_trial_plus_qst,
  control = lmerControl(
    optimizer = "bobyqa",
    optCtrl = list(maxfun = 5e5)
  )
)

summary(model3_5)

# emm = emmeans(model3_5, ~ cbq_effortful_control*block )
# pairs(emm)
# # or for simple comparisons
# #pairs(emm, simple = "each")

anova(model3_5, type = "III")
report(model3_5)

model3_5_x <- lmer(
  VLPFC_avg_score ~ c_age_y_centered +
    c_sex + cbq_fear * block + cbq_effortful_control * block + anxiety_c + stai_state * block +
    (1 + block | record_id) + (1 | trial),
  data = nirs_per_trial_plus_qst,
  control = lmerControl(
    optimizer = "bobyqa",
    optCtrl = list(maxfun = 5e5)
  )
)
model3_5_y <- lmer(
  VLPFC_avg_score ~ c_age_y_centered +
    c_sex + cbq_fear * block + cbq_effortful_control * block + anxiety_c + stai_state +
    (1 + block | record_id) + (1 | trial),
  data = nirs_per_trial_plus_qst,
  control = lmerControl(
    optimizer = "bobyqa",
    optCtrl = list(maxfun = 5e5)
  )
)
performance::compare_performance(model3_5, model3_5_x, model3_5_y)

## best model is model3_5 <-
```
##### Plot for Interaction: Fear
```{r}
interaction_eff3_5 <- ggpredict(model3_5, c("cbq_fear", "block"))
interaction_eff3_5

ggplot(interaction_eff3_5, aes(x, predicted, color = group)) +
  geom_line(linewidth = 1.2) +
  geom_ribbon(aes(ymin = conf.low, ymax = conf.high, fill = group), alpha = 0.2, color = NA) +
  theme_classic() +
  scale_color_manual(
    name = "Block Type",
    values = natparks.pals("Saguaro", 3),
    labels = c(
      "Block 1" = "Baseline",
      "Block 2" = "Stressful",
      "Block 3" = "Recovery"
    )
  ) +
  scale_fill_manual(
    name = "Block Type",
    values = natparks.pals("Saguaro", 3),
    labels = c(
      "Block 1" = "Baseline",
      "Block 2" = "Stressful",
      "Block 3" = "Recovery"
    )
  ) +
  scale_x_continuous(
    name = "Fear (CBQ scores)"
  ) +
  theme(
    axis.text = element_text(size = 19),
    axis.title = element_text(size = 20),
    legend.text = element_text(size = 19),
    legend.title = element_text(face = "bold", size = 19),
    legend.title.align = 0.5
  ) +
  scale_y_continuous(name = "VLPFC Neural Synchrony (predicted)", limits = c(0.29, .42), breaks = seq(0.29, .42, by = 0.02)) # Setting Y-axis limits and ticks


ggsave("figures/aim_3_F-Block_state_VLPFC.png", width = 10, height = 8)
```
##### Plot for Interaction: EC
```{r}
interaction_eff3_5_b <- ggpredict(model3_5, c("cbq_effortful_control", "block"))
interaction_eff3_5_b

ggplot(interaction_eff3_5_b, aes(x, predicted, color = group)) +
  geom_line(linewidth = 1.2) +
  geom_ribbon(aes(ymin = conf.low, ymax = conf.high, fill = group), alpha = 0.2, color = NA) +
  theme_classic() +
  scale_color_manual(
    name = "Block Type",
    values = natparks.pals("Saguaro", 3),
    labels = c(
      "Block 1" = "Baseline",
      "Block 2" = "Stressful",
      "Block 3" = "Recovery"
    )
  ) +
  scale_fill_manual(
    name = "Block Type",
    values = natparks.pals("Saguaro", 3),
    labels = c(
      "Block 1" = "Baseline",
      "Block 2" = "Stressful",
      "Block 3" = "Recovery"
    )
  ) +
  scale_x_continuous(
    name = "Effortful Control (CBQ scores)"
  ) +
  theme(
    axis.text = element_text(size = 19),
    axis.title = element_text(size = 20),
    legend.text = element_text(size = 19),
    legend.title = element_text(face = "bold", size = 19),
    legend.title.align = 0.5
  ) +
  scale_y_continuous(name = "VLPFC Neural Synchrony (predicted)", limits = c(0.29, .42), breaks = seq(0.29, .42, by = 0.02)) # Setting Y-axis limits and ticks


ggsave("figures/aim_3_EC-Block_state_VLPFC.png", width = 10, height = 8)
```

#### Trait - Model -block 2 reference

```{r}
nirs_per_trial_plus_qst$block <- factor(nirs_per_trial_plus_qst$block, levels = c("Block 2", "Block 1", "Block 3"))

model3_6 <- lmer(
  VLPFC_avg_score ~ c_age_y_centered +
    c_sex + cbq_fear * block + cbq_effortful_control * block + anxiety_c * block + stai_trait * block +
    (1 + block | record_id) + (1 | trial),
  data = nirs_per_trial_plus_qst,
  control = lmerControl(
    optimizer = "bobyqa",
    optCtrl = list(maxfun = 5e5)
  )
)

summary(model3_6)

# emm = emmeans(model3_6, ~ cbq_effortful_control*block )
# pairs(emm)
# # or for simple comparisons
# #pairs(emm, simple = "each")

anova(model3_6, type = "III")
report(model3_6)

performance::check_outliers(model3_6)


model3_6_x <- lmer(
  VLPFC_avg_score ~ c_age_y_centered +
    c_sex + cbq_fear * block + cbq_effortful_control * block + anxiety_c + stai_trait * block +
    (1 + block | record_id) + (1 | trial),
  data = nirs_per_trial_plus_qst,
  control = lmerControl(
    optimizer = "bobyqa",
    optCtrl = list(maxfun = 5e5)
  )
)

model3_6_y <- lmer(
  VLPFC_avg_score ~ c_age_y_centered +
    c_sex + cbq_fear * block + cbq_effortful_control * block + anxiety_c + stai_trait +
    (1 + block | record_id) + (1 | trial),
  data = nirs_per_trial_plus_qst,
  control = lmerControl(
    optimizer = "bobyqa",
    optCtrl = list(maxfun = 5e5)
  )
)

performance::compare_performance(model3_6, model3_6_x, model3_6_y)

## the best model is model3_6 <-
```

##### Plot for Interaction: Fear
```{r}
interaction_eff3_6 <- ggpredict(model3_6, c("cbq_fear", "block"))
interaction_eff3_6

ggplot(interaction_eff3_6, aes(x, predicted, color = group)) +
  geom_line(linewidth = 1.2) +
  geom_ribbon(aes(ymin = conf.low, ymax = conf.high, fill = group), alpha = 0.2, color = NA) +
  theme_classic() +
  scale_color_manual(
    name = "Block Type",
    values = natparks.pals("Saguaro", 3),
    labels = c(
      "Block 1" = "Baseline",
      "Block 2" = "Stressful",
      "Block 3" = "Recovery"
    )
  ) +
  scale_fill_manual(
    name = "Block Type",
    values = natparks.pals("Saguaro", 3),
    labels = c(
      "Block 1" = "Baseline",
      "Block 2" = "Stressful",
      "Block 3" = "Recovery"
    )
  ) +
  scale_x_continuous(
    name = "Fear (CBQ scores)"
  ) +
  theme(
    axis.text = element_text(size = 19),
    axis.title = element_text(size = 20),
    legend.text = element_text(size = 19),
    legend.title = element_text(face = "bold", size = 19),
    legend.title.align = 0.5
  ) +
  scale_y_continuous(name = "VLPFC Neural Synchrony (predicted)", limits = c(0.29, .42), breaks = seq(0.29, .42, by = 0.02)) # Setting Y-axis limits and ticks


ggsave("figures/aim_3_F-Block_trait_VLPFC.png", width = 10, height = 8)
```
##### Plot for Interaction: EC
```{r}
interaction_eff3_6_b <- ggpredict(model3_6, c("cbq_effortful_control", "block"))
interaction_eff3_6_b

ggplot(interaction_eff3_6_b, aes(x, predicted, color = group)) +
  geom_line(linewidth = 1.2) +
  geom_ribbon(aes(ymin = conf.low, ymax = conf.high, fill = group), alpha = 0.2, color = NA) +
  theme_classic() +
  scale_color_manual(
    name = "Block Type",
    values = natparks.pals("Saguaro", 3),
    labels = c(
      "Block 1" = "Baseline",
      "Block 2" = "Stressful",
      "Block 3" = "Recovery"
    )
  ) +
  scale_fill_manual(
    name = "Block Type",
    values = natparks.pals("Saguaro", 3),
    labels = c(
      "Block 1" = "Baseline",
      "Block 2" = "Stressful",
      "Block 3" = "Recovery"
    )
  ) +
  scale_x_continuous(
    name = "Effortful Control (CBQ scores)"
  ) +
  theme(
    axis.text = element_text(size = 19),
    axis.title = element_text(size = 20),
    legend.text = element_text(size = 19),
    legend.title = element_text(face = "bold", size = 19),
    legend.title.align = 0.5
  ) +
  scale_y_continuous(name = "VLPFC Neural Synchrony (predicted)", limits = c(0.29, .42), breaks = seq(0.29, .42, by = 0.02)) # Setting Y-axis limits and ticks


ggsave("figures/aim_3_EC-Block_trait_VLPFC.png", width = 10, height = 8)
```

### Graph: Anxiety Children vs. State Anxiety Parent
```{r}
nirs_plus_qst %>%
  distinct(record_id, .keep_all = TRUE) %>%
  select(record_id, DLPFC_avg_score, anxiety_c, stai_state, stai_trait) %>%
  ggplot(., aes(anxiety_c, DLPFC_avg_score)) +
  geom_point(size = 3) +
  labs(x = "Caregiver State Anxiety", y = "Dyadic Neural Synchrony Values") +
  geom_smooth(method = "lm") +
  scale_fill_brewer(palette = "Dark2") +
  scale_colour_brewer(palette = "Dark2") +
  guides(fill = FALSE, col = FALSE) +
  theme_apa() +
  theme(text = element_text(size = 25))

ggsave("figures/aim_3_corr_child_parent_state_anx.png", width = 12, height = 8)
```
### Graph: Anxiety Children vs. State Anxiety Parent
```{r}
nirs_plus_qst %>%
  distinct(record_id, .keep_all = TRUE) %>%
  select(record_id, DLPFC_avg_score, anxiety_c, stai_state, stai_trait) %>%
  ggplot(., aes(stai_state, anxiety_c)) +
  geom_point(size = 3) +
  labs(x = "Caregiver State Anxiety", y = "Child Anxiety") +
  geom_smooth(method = "lm") +
  scale_fill_brewer(palette = "Dark2") +
  scale_colour_brewer(palette = "Dark2") +
  guides(fill = FALSE, col = FALSE) +
  theme_apa() +
  theme(text = element_text(size = 25))

ggsave("figures/aim_3_corr_child_parent_state_anx.png", width = 12, height = 8)
```

### Graph: Anxiety Children vs. Trait Anxiety Parent
```{r}
nirs_plus_qst %>%
  distinct(record_id, .keep_all = TRUE) %>%
  select(record_id, DLPFC_avg_score, anxiety_c, stai_state, stai_trait) %>%
  ggplot(., aes(stai_trait, anxiety_c)) +
  geom_point(size = 3) +
  labs(x = "Caregiver Trait Anxiety", y = "Child Anxiety Score") +
  geom_smooth(method = "lm") +
  scale_fill_brewer(palette = "Dark2") +
  scale_colour_brewer(palette = "Dark2") +
  guides(fill = FALSE, col = FALSE) +
  theme_apa() +
  theme(text = element_text(size = 25))

ggsave("figures/aim_3_corr_child_parent_trait_anx.png", width = 12, height = 8)
```

### Report-State

```{r}
tab_model(model3_1, model3_3, model3_5, p.val = "kr", show.df = TRUE, collapse.ci = TRUE, p.style = "stars", digits = 3)
```


### Report-Trait

```{r}
tab_model(model3_2, model3_4, model3_6, p.val = "kr", show.df = TRUE, collapse.ci = TRUE, p.style = "stars", digits = 3)
```


## 4. Correlations with all 
```{r}
report(cor.test(block1$stai_state, block1$cbq_fear, method = "pearson", conf.level = 0.95))
report(cor.test(block1$stai_trait, block1$cbq_fear, method = "pearson", conf.level = 0.95))
report(cor.test(block1$anxiety_c, block1$cbq_fear, method = "pearson", conf.level = 0.95))
report(cor.test(block1$stai_state, block1$cbq_effortful_control, method = "pearson", conf.level = 0.95))
report(cor.test(block1$stai_trait, block1$cbq_effortful_control, method = "pearson", conf.level = 0.95))
report(cor.test(block1$anxiety_c, block1$cbq_effortful_control, method = "pearson", conf.level = 0.95))
report(cor.test(block1$stai_state, block1$stai_trait, method = "pearson", conf.level = 0.95))
report(cor.test(block1$stai_trait, block1$anxiety_c, method = "pearson", conf.level = 0.95))
report(cor.test(block1$stai_state, block1$anxiety_c, method = "pearson", conf.level = 0.95))
report(cor.test(block1$cbq_effortful_control, block1$anxiety_c, method = "pearson", conf.level = 0.95))
```
